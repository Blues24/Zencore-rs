name: Zencore Windows Release

on:
  create:
    tags:
      - 'v*'   # otomatis build saat tag dibuat
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag yang ingin dibuild untuk Windows (misalnya v1.0.0-Noble)"
        required: true
        default: "v1.0.0-manual"

jobs:
  build-windows:
    name: Build Windows binary (cross-compile)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag || github.ref_name }}

      - name: Set up Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: x86_64-pc-windows-gnu
          override: true

      - name: Install mingw-w64 for cross-compiling
        run: sudo apt-get update && sudo apt-get install -y mingw-w64

      - name: Build Windows executable
        run: |
          cargo build --release --target x86_64-pc-windows-gnu --locked

      - name: Determine binary name
        id: binname
        run: |
          BIN_NAME=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].name')
          echo "bin_name=$BIN_NAME" >> $GITHUB_OUTPUT

      - name: Prepare artifacts
        run: mkdir -p artifacts

      - name: Move .exe binary and compress
        run: |
          BIN_NAME="zencore"
          VERSION="${{ github.event.inputs.tag || github.ref_name }}"
          cp "target/x86_64-pc-windows-gnu/release/${BIN_NAME}.exe" "artifacts/"
          cd artifacts
          zip ${BIN_NAME}-${VERSION}-windows.zip ${BIN_NAME}.exe
          sha256sum ${BIN_NAME}-${VERSION}-windows.zip > ${BIN_NAME}-${VERSION}-windows.zip.sha256

      - name: Upload artifact (Windows binary)
        uses: actions/upload-artifact@v4
        with:
          name: windows-binary-${{ github.event.inputs.tag || github.ref_name }}
          path: artifacts/*
